<!DOCTYPE html>
<html>
<head>
    <title>MESE-Next</title>
    <meta charset='utf-8' />
</head>
<body>
    <div id='login'>
        <p>Name: <input id='login_name' type='text' /></p>
        <p>Password: <input id='login_password' type='password' /></p>
        <p><input id='login_go' type='submit' value='Go!' /></p>
    </div>

    <div id='user' style='display: none'>
        <p>Login user: <span id='user_name'></span></p>
        <hr>
        <p>Password: <input id='user_password' type='password' /></p>
        <p>New password: <input id='user_new_password' type='password' /></p>
        <p><input id='user_change_password' type='submit' value='Change password' /></p>
    </div>

    <div id='list' style='display: none'>
    </div>

    <div id='report' style='display: none'>
        <h1>Game: <span bind='game'></span></h1>
        <hr>
        <div bind='settings'>
            <h2>Settings</h2>
            <div bind='limits'>
                <h3>Limits</h3>
                <p>Price: <span bind='price_min'></span> - <span bind='price_max'></span></p>
                <p>MK: 0 - <span bind='mk_limit'></span></p>
                <p>CI: 0 - <span bind='ci_limit'></span></p>
                <p>RD: 0 - <span bind='rd_limit'></span></p>
                <p>Loan: 0 - <span bind='loan_limit'></span></p>
            </div>
            <div bind='production'>
                <h3>Production</h3>
                <p>Balanced production rate: <span bind='prod_rate_balanced'></span></p>
                <!-- <p>prod_rate_pow: <span bind='prod_rate_pow'></span></p>
                <p>prod_cost_factor_rate_over: <span bind='prod_cost_factor_rate_over'></span></p>
                <p>prod_cost_factor_rate_under: <span bind='prod_cost_factor_rate_under'></span></p>
                <p>prod_cost_factor_size: <span bind='prod_cost_factor_size'></span></p>
                <p>prod_cost_factor_const: <span bind='prod_cost_factor_const'></span></p> -->

                <p>Unit fee: <span bind='unit_fee'></span></p>
                <p>Deprecation rate: <span bind='deprecation_rate'></span></p>
            </div>
            <div bind='balance'>
                <h3>Balance</h3>
                <p>Interest rate (cash): <span bind='interest_rate_cash'></span></p>
                <p>Interest rate (loan): <span bind='interest_rate_loan'></span></p>
                <p>Inventory fee: <span bind='inventory_fee'></span></p>
                <p>Tax rate: <span bind='tax_rate'></span></p>
            </div>
        </div>
        <div bind='decisions'>
            <h2>Decisions</h2>
            <p>
                <span bind='price'></span>,
                <span bind='prod'></span>,
                <span bind='mk'></span>,
                <span bind='ci'></span>,
                <span bind='rd'></span>
            </p>
        </div>
        <div bind='data_early'>
            <h2>Player report</h2>
            <div bind='production'>
                <h3>Production</h3>
                <p>Production rate: <span bind='prod_rate'></span> (<span bind='prod_over'></span>)</p>
                <p>Unit production cost: <span bind='prod_cost_unit'></span></p>
                <p>Marginal production cost: <span bind='prod_cost_marginal'></span></p>
                <p>Total production cost: <span bind='prod_cost'></span></p>
            </div>
            <div bind='balance'>
                <h3>Balance</h3>
                <p>Deprecation: <span bind='deprecation'></span></p>
                <p>Capital: <span bind='capital'></span></p>
                <p>Size: <span bind='size'></span></p>
                <p>Spending: <span bind='spending'></span></p>
                <p>Balance before period: <span bind='balance_early'></span></p>
                <p>Loan before period: <span bind='loan_early'></span></p>
                <p>Interest: <span bind='interest'></span></p>

                <p>Goods: <span bind='goods'></span></p>
                <p>Cost of goods: <span bind='goods_cost'></span></p>
                <p>Ideal sales of goods: <span bind='goods_max_sales'></span></p>
            </div>
            <div bind='history'>
                <h3>History</h3>
                <p>Total MK: <span bind='history_mk'></span></p>
                <p>Total RD: <span bind='history_rd'></span></p>
            </div>
        </div>
        <div bind='data'>
            <div bind='orders'>
                <h3>Units</h3>
                <p>Orders: <span bind='orders'></span></p>
                <p>Sold: <span bind='sold'></span></p>
                <p>Inventory: <span bind='inventory'></span></p>
                <p>Unfilled: <span bind='unfilled'></span></p>
            </div>
            <div bind='balance'>
                <h3>Balance</h3>
                <p>Cost of goods sold: <span bind='goods_cost_sold'></span></p>
                <p>Cost of inventory: <span bind='goods_cost_inventory'></span></p>

                <p>Sales: <span bind='sales'></span></p>
                <p>Inventory charge: <span bind='inventory_charge'></span></p>
                <p>Cost before tax: <span bind='cost_before_tax'></span></p>
                <p>Profit before tax: <span bind='profit_before_tax'></span></p>
                <p>Tax charge: <span bind='tax_charge'></span></p>
                <p>Profit: <span bind='profit'></span></p>

                <p>Balance: <span bind='balance'></span></p>
                <p>Loan: <span bind='loan'></span></p>
                <p>Cash: <span bind='cash'></span></p>
                <p>Retained earning: <span bind='retern'></span></p>
            </div>
            <div bind='mpi'>
                <h3>MPI</h3>
                <p><span bind='mpi'></span></p>
            </div>
        </div>
        <!-- <div bind='data_public'>
            <h2>Public report</h2>
            <div bind='???'>
                <h3>???</h3>
                <p>???: <span bind='???'></span></p>
            </div>
            <div bind='???'>
                <h3>???</h3>
                <p>???: <span bind='???'></span></p>
            </div>
            <div bind='???'>
                <h3>???</h3>
                <p>???: <span bind='???'></span></p>
            </div>
        </div> -->
    </div>

    <div id='submit' style='display: none'>
        <p>Price: <input id='submit_price' type='number' /></p>
        <p>Production: <input id='submit_prod' type='number' /></p>
        <p>Marketing: <input id='submit_mk' type='number' /></p>
        <p>Investment: <input id='submit_ci' type='number' /></p>
        <p>R &amp; D: <input id='submit_rd' type='number' /></p>
        <p><input id='submit_submit' type='submit' value='Submit' /></p>
    </div>

    <script src='http://code.jquery.com/jquery-1.11.3.min.js'></script>
    <script src='/socket.io/socket.io.js'></script>

    <style>
        #report span[target=last] {
            color: gray;
        }

        #report span[target=now] {
        }

        #report span[target=next] {
            color: blue;
        }
    </style>

    <script>
        'use strict';

        var socket = io(window.location.origin);

        var currentGame = undefined;
        var currentPeriod = undefined;

        // login

        $('#login_name').keypress(function (event) {
            if (event.which === 13) {
                $('#login_password').focus();
            }
        });

        $('#login_password').keypress(function (event) {
            if (event.which === 13) {
                $('#login_go').click();
            }
        });

        $('#login_go').click(function () {
            var name = $('#login_name').val();
            var password = $('#login_password').val();
            $('#login_password').val('');

            socket.emit('login', {
                name: name,
                password: password, // TODO: hash?
            });
        });

        socket.on('login_new', function (data) {
            $('#user_name').text(data.name + ' (new user)');
            $('#user').css('display', 'block');

            socket.emit('list');
        });

        socket.on('login_ok', function (data) {
            $('#user_name').text(data.name);
            $('#user').css('display', 'block');

            socket.emit('list');
        });

        socket.on('login_fail', function (data) {
            // TODO
            console.log('Wrong password!');
        });

        // user

        $('#user_password').keypress(function (event) {
            if (event.which === 13) {
                $('#user_new_password').focus();
            }
        });

        $('#user_new_password').keypress(function (event) {
            if (event.which === 13) {
                $('#user_change_password').click();
            }
        });

        $('#user_change_password').click(function () {
            var password = $('#user_password').val();
            var newPassword = $('#user_new_password').val();
            $('#user_password').val('');
            $('#user_new_password').val('');

            socket.emit('password', {
                password: password, // TODO: hash?
                newPassword: newPassword, // TODO: hash?
            });
        });

        socket.on('password_ok', function (data) {
            // TODO
            console.log('Password changed!');
        });

        socket.on('password_fail', function (data) {
            // TODO
            console.log('Wrong password!');
        });

        // list

        var updateList = function (data) {
            $('#list').css('display', 'none');
            $('#list').empty();

            for (var i in data) {
                if (data[i]) {
                    $('<input type="button" />')
                        .addClass('list_member')
                        .val(i)
                        .click(function (game) {
                            return function () {
                                socket.emit('report', {
                                    game: game,
                                });
                            }
                        } (i))
                        .appendTo('#list');
                }
            }

            $('#list').css('display', 'block');
        };

        socket.on('subscribe_list', updateList);

        socket.on('subscribe_update', updateList);

        // TODO: subscribe changes

        // report

        $('#report span[bind]')
            .append(
                $('<span />')
                    .text('last: ')
                    .attr('target', 'last')
                    .append('<span />')
            )
            .append(
                $('<span />')
                    .attr('target', 'now')
                    .append('<span />')
            )
            .append(
                $('<span />')
                    .text('next: ')
                    .attr('target', 'next')
                    .append('<span />')
            );

        var initReport = function () {
            $('#report span[target]').css('display', 'none');
        };

        var showReport = function (head, data, tail) {
            if (typeof data == 'string' || typeof data == 'number') {
                $(head + ' ' + tail + ' span').text(data);
                $(head + ' ' + tail).css('display', 'inline');
            } else if (typeof data == 'object') {
                for (var i in data) {
                    showReport(head + ' [bind=' + i + ']', data[i], tail);
                }
            }
        };

        socket.on('report_early', function (data) {
            showReport('#report [bind=decisions]', data.decisions, '[target=next]');
            showReport('#report [bind=data_early]', data.data_early, '[target=next]');
        });

        socket.on('report_player', function (data) {
            currentGame = data.game;
            currentPeriod = data.now_period;

            initReport();
            showReport('#report [bind=decisions]', data.last_decisions, '[target=last]');
            showReport('#report [bind=data_early]', data.last_data_early, '[target=last]');
            showReport('#report [bind=data]', data.last_data, '[target=last]');
            showReport('#report [bind=data_public]', data.last_data_public, '[target=last]');
            showReport('#report [bind=settings]', data.settings, '[target=now]');
            showReport('#report [bind=decisions]', data.decisions, '[target=now]');
            showReport('#report [bind=data_early]', data.data_early, '[target=now]');
            showReport('#report [bind=data]', data.data, '[target=now]');
            showReport('#report [bind=data_public]', data.data_public, '[target=now]');
            showReport('#report [bind=settings]', data.next_settings, '[target=next]');

            $('#report').css('display', 'block');
            $('#submit').css('display', 'block');
        });

        socket.on('report_public', function (data) {
            currentGame = data.game;

            initReport();
            showReport('#report [bind=data_public]', data.last_data_public, '[target=last]');
            showReport('#report [bind=settings]', data.settings, '[target=now]');
            showReport('#report [bind=data_public]', data.data_public, '[target=now]');
            showReport('#report [bind=settings]', data.next_settings, '[target=next]');

            $('#report').css('display', 'block');
            $('#submit').css('display', 'none');
        });

        // submit

        $('#submit_submit').click(function () {
            socket.emit('submit', {
                game: currentGame,
                price: parseInt($('#submit_price').val()),
                prod: parseInt($('#submit_prod').val()),
                mk: parseInt($('#submit_mk').val()),
                ci: parseInt($('#submit_ci').val()),
                rd: parseInt($('#submit_rd').val()),
            });
        });

        socket.on('submit_ok', function (data) {
            // TODO
            console.log('Submit ok!');
        });

        socket.on('submit_decline', function (data) {
            // TODO
            console.log('Submit decline!');
        });

        socket.on('submit_fail', function (data) {
            // TODO
            console.log('Submit fail!');
        });
</script>
</body>
</html>