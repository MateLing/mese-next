<!DOCTYPE html>
<html>
<head>
    <title>MESE-Next</title>
    <meta charset='utf-8' />
</head>
<body>
    <div id='login'>
        <p>Name: <input id='login_name' type='text' /></p>
        <p>Password: <input id='login_password' type='password' /></p>
        <p><input id='login_remember' type='checkbox' checked />Remember me</p>
        <p><input id='login_go' type='submit' value='Go!' /></p>
    </div>

    <div id='user' class='hide'>
        <p>Login user: <span id='user_name'></span></p>
        <hr>
        <p>Password: <input id='user_password' type='password' /></p>
        <p>New password: <input id='user_new_password' type='password' /></p>
        <p><input id='user_change_password' type='submit' value='Change password' /></p>
    </div>

    <div id='list' class='hide'>
    </div>

    <div id='report' class='hide'>
        <h1>Game: <span bind='game'></span></h1><!-- TODO -->
        <hr>
        <div class='report_div' bind='data_early'>
            <h3>Early report</h3>
            <table bind='production'>
                <tr><th>Production</th><th>You</th><th>Average</th></tr>
                <tr><td>Production rate</td><td><span bind='prod_rate'></span></td></tr>
                <tr><td></td><td>[<span bind='prod_over'></span>]</td></tr>
                <tr><td>Unit production cost</td><td><span bind='prod_cost_unit'></span></td><td><span bind='average_prod_cost_unit'></span></td></tr>
                <tr><td>Marginal production cost</td><td><span bind='prod_cost_marginal'></span></td></tr>
                <tr><td>Total production cost</td><td><span bind='prod_cost'></span></td><td><span bind='average_prod_cost'></span></td></tr>
            </table>
            <table bind='balance'>
                <tr><th>Balance</th><th>You</th><th>Average</th></tr>
                <tr><td>Deprecation</td><td><span bind='deprecation'></span></td></tr>
                <tr><td>Capital</td><td><span bind='capital'></span></td><td><span bind='average_capital'></span></td></tr>
                <tr><td>Size</td><td><span bind='size'></span></td><td><span bind='average_size'></span></td></tr>
                <tr><td>Spending</td><td><span bind='spending'></span></td></tr>
                <tr><td>Balance before period</td><td><span bind='balance_early'></span></td></tr>
                <tr><td>Loan before period</td><td><span bind='loan_early'></span></td></tr>
                <tr><td>Interest</td><td><span bind='interest'></span></td></tr>

                <tr><td>Goods</td><td><span bind='goods'></span></td><td><span bind='average_goods'></span></td></tr>
                <tr><td>Cost of goods</td><td><span bind='goods_cost'></span></td></tr>
                <tr><td>Ideal sales of goods</td><td><span bind='goods_max_sales'></span></td></tr>
            </table>
            <table bind='history'>
                <tr><th>History</th></tr>
                <tr><td>Total marketing</td><td><span bind='history_mk'></span></td></tr>
                <tr><td>Total R &amp; D</td><td><span bind='history_rd'></span></td></tr>
            </table>
        </div>
        <div class='report_div' bind='data'>
            <h3>Result report</h3>
            <table bind='orders'>
                <tr><th>Units</th><th>You</th><th>Average</th></tr>
                <tr><td>Orders</td><td><span bind='orders'></span></td><td><span bind='average_orders'></span></td></tr>
                <tr><td>Sold</td><td><span bind='sold'></span></td><td><span bind='average_sold'></span></td></tr>
                <tr><td>Inventory</td><td><span bind='inventory'></span></td><td><span bind='average_inventory'></span></td></tr>
                <tr><td>Unfilled</td><td><span bind='unfilled'></span></td><td><span bind='average_unfilled'></span></td></tr>
            </table>
            <table bind='balance'>
                <tr><th>Balance</th><th>You</th><th>Average</th></tr>
                <tr><td>Cost of goods sold</td><td><span bind='goods_cost_sold'></span></td><td><span bind='average_goods_cost_sold'></span></td></tr>
                <tr><td>Cost of inventory</td><td><span bind='goods_cost_inventory'></span></td></tr>

                <tr><td>Sales</td><td><span bind='sales'></span></td><td><span bind='average_sales'></span></td></tr>
                <tr><td>Inventory charge</td><td><span bind='inventory_charge'></span></td></tr>
                <tr><td>Cost before tax</td><td><span bind='cost_before_tax'></span></td><td><span bind='average_cost_before_tax'></span></td></tr>
                <tr><td>Profit before tax</td><td><span bind='profit_before_tax'></span></td><td><span bind='average_profit_before_tax'></span></td></tr>
                <tr><td>Tax charge</td><td><span bind='tax_charge'></span></td><td><span bind='average_tax_charge'></span></td></tr>
                <tr><td>Profit</td><td><span bind='profit'></span></td><td><span bind='average_profit'></span></td></tr>

                <tr><td>Balance</td><td><span bind='balance'></span></td></tr>
                <tr><td>Loan</td><td><span bind='loan'></span></td></tr>
                <tr><td>Cash</td><td><span bind='cash'></span></td></tr>
                <tr><td>Retained earning</td><td><span bind='retern'></span></td><td><span bind='average_retern'></span></td></tr>
            </table>
            <table bind='mpi'>
                <tr><th>MPI</th><th>You</th><th>Average</th></tr>
                <tr><td>MPI</td><td><span bind='mpi'></span></td><td><span bind='average_mpi'></span></td></tr>
            </table>
        </div>
        <div class='report_div report_list_div'>
            <h3>Players' detail</h3>
            <table id='report_list'>
                <tr id='report_players'><th></th></tr>
                <tr xbind='price'><td>Price</td></tr>
                <tr xbind='sold'><td>Sold</td></tr>
                <tr xbind='sales'><td>Sales</td></tr>
                <tr xbind='cost_before_tax'><td>Cost before tax</td></tr>
                <tr xbind='profit_before_tax'><td>Profit before tax</td></tr>
                <tr xbind='tax_charge'><td>Tax charge</td></tr>
                <tr xbind='profit'><td>Profit</td></tr>
                <tr xbind='retern'><td>Retained earning</td></tr>
                <tr xbind='mpi'><td>MPI</td></tr>
            </table>
        </div>
        <div class='report_div' bind='settings'>
            <h3>Settings</h3>
            <table bind='limits'>
                <tr><th>Limits</th></tr>
                <tr><td>Min price</td><td><span bind='price_min'></span></td></tr>
                <tr><td>Max price</td><td><span bind='price_max'></span></td></tr>
                <tr><td>Max marketing</td><td><span bind='mk_limit'></span></td></tr>
                <tr><td>Max investment</td><td><span bind='ci_limit'></span></td></tr>
                <tr><td>Max R &amp; D</td><td><span bind='rd_limit'></span></td></tr>
                <tr><td>Max loan</td><td><span bind='loan_limit'></span></td></tr>
            </table>
            <table bind='production'>
                <tr><th>Production</th></tr>
                <tr><td>Balanced production rate</td><td><span bind='prod_rate_balanced'></span></td></tr>
                <!-- <tr><td>prod_rate_pow</td><td><span bind='prod_rate_pow'></span></td></tr>
                <tr><td>prod_cost_factor_rate_over</td><td><span bind='prod_cost_factor_rate_over'></span></td></tr>
                <tr><td>prod_cost_factor_rate_under</td><td><span bind='prod_cost_factor_rate_under'></span></td></tr>
                <tr><td>prod_cost_factor_size</td><td><span bind='prod_cost_factor_size'></span></td></tr>
                <tr><td>prod_cost_factor_const</td><td><span bind='prod_cost_factor_const'></span></td></tr> -->

                <tr><td>Unit fee</td><td><span bind='unit_fee'></span></td></tr>
                <tr><td>Deprecation rate</td><td><span bind='deprecation_rate'></span></td></tr>
            </table>
            <table bind='balance'>
                <tr><th>Balance</th></tr>
                <tr><td>Interest rate (cash)</td><td><span bind='interest_rate_cash'></span></td></tr>
                <tr><td>Interest rate (loan)</td><td><span bind='interest_rate_loan'></span></td></tr>
                <tr><td>Inventory fee</td><td><span bind='inventory_fee'></span></td></tr>
                <tr><td>Tax rate</td><td><span bind='tax_rate'></span></td></tr>
            </table>
        </div>
        <div class='report_div' bind='decisions'>
            <h3>Decisions</h3>
            <table>
                <tr><th>Prices</th></tr>
                <tr><td>Average price (given)</td><td><span bind='average_price_given'></span></td></tr>
                <tr><td>Average price (sold)</td><td><span bind='average_price'></span></td></tr>
            </table>
            <!-- notice: special unit -->
            <table>
                <tr><th>Decisions</th></tr>
                <tr><td>Price</td><td><span bind='price'></span></td><td><input id='submit_price' type='number' /></td></tr>
                <tr><td>Production</td><td><span bind='prod'></span></td><td><input id='submit_prod' type='number' /></td></tr>
                <tr><td>Marketing</td><td><span bind='mk'></span></td><td><input id='submit_mk' type='number' /></td></tr>
                <tr><td>Investment</td><td><span bind='ci'></span></td><td><input id='submit_ci' type='number' /></td></tr>
                <tr><td>R &amp; D</td><td><span bind='rd'></span></td><td><input id='submit_rd' type='number' /></td></tr>
                <tr><td></td><td></td><td><input id='submit_submit' type='submit' value='Submit' /></td></tr>
            </table>
        </div>
    </div>

    <script src='http://code.jquery.com/jquery-1.11.3.min.js'></script>
    <script src='/socket.io/socket.io.js'></script>

    <style>
        .hide {
            display: none;
        }

        .report_div {
            display: inline-block;
            vertical-align: top;

            width: 40%;
            min-width: 32em;

            font-family: monospace;
        }
        .report_list_div {
            width: 80% !important;
            min-width: 64em !important;
        }

        .report_div table {
            width: 100%;
        }

        .report_div tr>* {
            text-align: right;
        }
        .report_div tr>:first-child {
            text-align: left !important;

            width: 50%;
        }
        .report_list_div tr>:first-child {
            width: 25% !important;
        }

        .report_div [target=last] {
            color: gray;
        }
        .report_div [target=now] {
        }
        .report_div [target=next] {
            color: blue;
        }
    </style>

    <script>
        'use strict';

        var socket = io(window.location.origin);

        // login

        var currentName = undefined;

        // auto login
        var loginInfo = localStorage.getItem('MESE_login');
        if (loginInfo) {
            socket.emit('login', JSON.parse(loginInfo));
        }

        $('#login_name').keypress(function (event) {
            if (event.which === 13) {
                $('#login_password').focus();
            }
        });

        $('#login_password').keypress(function (event) {
            if (event.which === 13) {
                $('#login_go').click();
            }
        });

        $('#login_go').click(function () {
            var name = $('#login_name').val();
            var password = $('#login_password').val();
            $('#login_password').val('');

            // auto login
            if ($('#login_remember').prop('checked')) {
                localStorage.setItem(
                    'MESE_login',
                    JSON.stringify({
                        name: name,
                        password: password, // TODO: hash?
                    })
                );
            } else {
                localStorage.removeItem('MESE_login');
            }

            socket.emit('login', {
                name: name,
                password: password, // TODO: hash?
            });
        });

        socket.on('login_new', function (data) {
            currentName = data.name;

            $('#user_name').text(currentName + ' (new user)');

            $('#user').removeClass('hide');
            $('#list').addClass('hide');
            $('#report').addClass('hide');

            socket.emit('list');
        });

        socket.on('login_ok', function (data) {
            currentName = data.name;

            $('#user_name').text(currentName);

            $('#user').removeClass('hide');
            $('#list').addClass('hide');
            $('#report').addClass('hide');

            socket.emit('list');
        });

        socket.on('login_fail', function (data) {
            // TODO
            console.log('Wrong password!');
        });

        // user

        $('#user_password').keypress(function (event) {
            if (event.which === 13) {
                $('#user_new_password').focus();
            }
        });

        $('#user_new_password').keypress(function (event) {
            if (event.which === 13) {
                $('#user_change_password').click();
            }
        });

        $('#user_change_password').click(function () {
            var password = $('#user_password').val();
            var newPassword = $('#user_new_password').val();
            $('#user_password').val('');
            $('#user_new_password').val('');

            // auto login
            var loginInfo = localStorage.getItem('MESE_login');
            if (loginInfo) {
                localStorage.setItem(
                    'MESE_login',
                    JSON.stringify({
                        name: JSON.parse(loginInfo).name,
                        password: newPassword, // TODO: hash?
                    })
                );
            }

            socket.emit('password', {
                password: password, // TODO: hash?
                newPassword: newPassword, // TODO: hash?
            });
        });

        socket.on('password_ok', function (data) {
            // TODO
            console.log('Password changed!');
        });

        socket.on('password_fail', function (data) {
            // TODO
            console.log('Wrong password!');
        });

        // list

        var updateList = function (data) {
            $('#list').empty();

            for (var i in data) {
                if (data[i]) {
                    $('<input type="button" />')
                        .val(i)
                        .click(function (game) {
                            return function () {
                                socket.emit('report', {
                                    game: game,
                                });
                            }
                        } (i))
                        .appendTo('#list');
                }
            }

            $('#list').removeClass('hide');
            $('#report').addClass('hide');
        };

        socket.on('subscribe_list', updateList);

        socket.on('subscribe_update', updateList);

        // TODO: subscribe changes

        // report

        var currentGame = undefined;
        var currentPeriod = undefined;

        for (var i = 0; i < 16; ++i) { // max = 16
            $('#report_players')
                .append('<th><span bind="' + i + '"></span></th>');
            $('#report_list [xbind]')
                .append('<td><span bind="' + i + '"></span></td>');
        }

        $('#report span[bind]')
            .append('<span target="last">(Last: <span></span>) </span>')
            .append('<span target="now"><span></span></span>')
            .append('<span target="next"> (Next: <span></span>)</span>');

        var initReport = function () {
            $('#report [target]').addClass('hide');
        };

        var showReport = function (head, data, tail, xbind /* patch */) {
            if (typeof data == 'string' || typeof data == 'number') {
                var target = $(head + ' [target=' + tail + ']');

                if (target.length == 1) {
                    target.find('span').text(data);
                    target.removeClass('hide');
                }
            } else if (typeof data == 'object') {
                for (var i in data) {
                    // top-level bind
                    if (!xbind && $('#report [xbind=' + i + ']').length == 1) {
                        showReport('#report [xbind=' + i + ']', data[i], tail, true);
                    }

                    // path-based bind
                    showReport(head + ' [bind=' + i + ']', data[i], tail);
                }
            }
        };

        socket.on('report_early', function (data) {
            showReport('#report [bind=decisions]', data.decisions, 'next');
            showReport('#report [bind=data_early]', data.data_early, 'next');
        });

        socket.on('report_player', function (data) {
            currentGame = data.game;
            currentPeriod = data.now_period;

            initReport();

            showReport('#report_players', data.players, 'now');

            if (data.now_period >= 3) {
                // showReport('#report [bind=decisions]', data.last_decisions, 'last');
                // showReport('#report [bind=data_early]', data.last_data_early, 'last');
                // showReport('#report [bind=data]', data.last_data, 'last');
                showReport('#report [bind=decisions]', data.last_data_public.decisions, 'last');
                showReport('#report [bind=data_early]', data.last_data_public.data_early, 'last');
                showReport('#report [bind=data]', data.last_data_public.data, 'last');
            }

            showReport('#report [bind=settings]', data.settings, 'now');
            showReport('#report [bind=decisions]', data.decisions, 'now');
            showReport('#report [bind=data_early]', data.data_early, 'now');
            showReport('#report [bind=data]', data.data, 'now');
            showReport('#report [bind=decisions]', data.data_public.decisions, 'now');
            showReport('#report [bind=data_early]', data.data_public.data_early, 'now');
            showReport('#report [bind=data]', data.data_public.data, 'now');

            showReport('#report [bind=settings]', data.next_settings, 'next');

            $('#report').removeClass('hide');
            // $('#submit').removeClass('hide'); // TODO: more show/hide in report
        });

        socket.on('report_public', function (data) {
            currentGame = data.game;

            initReport();

            showReport('#report_players', data.players, 'now');

            if (data.now_period >= 3) {
                showReport('#report [bind=decisions]', data.last_data_public.decisions, 'last');
                showReport('#report [bind=data_early]', data.last_data_public.data_early, 'last');
                showReport('#report [bind=data]', data.last_data_public.data, 'last');
            }

            showReport('#report [bind=settings]', data.settings, 'now');
            showReport('#report [bind=decisions]', data.data_public.decisions, 'now');
            showReport('#report [bind=data_early]', data.data_public.data_early, 'now');
            showReport('#report [bind=data]', data.data_public.data, 'now');

            showReport('#report [bind=settings]', data.next_settings, 'next');

            $('#report').removeClass('hide');
            // $('#submit').addClass('hide'); // TODO: more show/hide in report
        });

        // submit

        $('#submit_submit').click(function () {
            socket.emit('submit', {
                game: currentGame,
                period: currentPeriod,
                price: parseInt($('#submit_price').val()),
                prod: parseInt($('#submit_prod').val()),
                mk: parseInt($('#submit_mk').val()),
                ci: parseInt($('#submit_ci').val()),
                rd: parseInt($('#submit_rd').val()),
            });
        });

        socket.on('submit_ok', function (data) {
            // TODO
            console.log('Submit ok!');
        });

        socket.on('submit_decline', function (data) {
            // TODO
            console.log('Submit decline!');
        });

        socket.on('submit_fail', function (data) {
            // TODO
            console.log('Submit fail!');
        });
</script>
</body>
</html>